<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="google-site-verification" content="google63cd143b1fbb3ff4.html">













  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Python,Transitions,状态机库,">





  <link rel="alternate" href="/atom.xml" title="LiuYang's BLOG" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="由于项目需要，使用到了Python的状态机库 Transitions ，但GitHub上是英文文档，使用过后觉得还不错，遂手工翻译一下，加深理解，水平有限，如有翻译不当之处请Email (kevin920902@gmail.com) 我。 TransitionsPython 实现的轻量级、面向对象状态机，兼容Python 2.7+ 和 Python 3.0+。 安装方法方法一 1pip insta">
<meta name="keywords" content="Python,Transitions,状态机库">
<meta property="og:type" content="article">
<meta property="og:title" content="Transitions-Python状态机库">
<meta property="og:url" content="http://runnerliu.github.io/2017/05/26/transitionstranslate/index.html">
<meta property="og:site_name" content="LiuYang&#39;s BLOG">
<meta property="og:description" content="由于项目需要，使用到了Python的状态机库 Transitions ，但GitHub上是英文文档，使用过后觉得还不错，遂手工翻译一下，加深理解，水平有限，如有翻译不当之处请Email (kevin920902@gmail.com) 我。 TransitionsPython 实现的轻量级、面向对象状态机，兼容Python 2.7+ 和 Python 3.0+。 安装方法方法一 1pip insta">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-11-15T02:24:39.483Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Transitions-Python状态机库">
<meta name="twitter:description" content="由于项目需要，使用到了Python的状态机库 Transitions ，但GitHub上是英文文档，使用过后觉得还不错，遂手工翻译一下，加深理解，水平有限，如有翻译不当之处请Email (kevin920902@gmail.com) 我。 TransitionsPython 实现的轻量级、面向对象状态机，兼容Python 2.7+ 和 Python 3.0+。 安装方法方法一 1pip insta">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://runnerliu.github.io/2017/05/26/transitionstranslate/">





  <title> Transitions-Python状态机库 | LiuYang's BLOG </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">LiuYang's BLOG</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">On the way to become a Software Architect</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://runnerliu.github.io/2017/05/26/transitionstranslate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="william">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiuYang's BLOG">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Transitions-Python状态机库
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-26T21:12:18+08:00">
                2017-05-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/05/26/transitionstranslate/" class="leancloud_visitors" data-flag-title="Transitions-Python状态机库">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>由于项目需要，使用到了Python的状态机库 <a href="https://github.com/tyarkoni/transitions" target="_blank" rel="noopener">Transitions</a> ，但GitHub上是英文文档，使用过后觉得还不错，遂手工翻译一下，加深理解，水平有限，如有翻译不当之处请Email (<a href="mailto:kevin920902@gmail.com" target="_blank" rel="noopener">kevin920902@gmail.com</a>) 我。</p>
<h2 id="Transitions"><a href="#Transitions" class="headerlink" title="Transitions"></a>Transitions</h2><p>Python 实现的轻量级、面向对象状态机，兼容Python 2.7+ 和 Python 3.0+。</p>
<h2 id="安装方法"><a href="#安装方法" class="headerlink" title="安装方法"></a>安装方法</h2><p>方法一</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install transitions</span><br></pre></td></tr></table></figure>
<p>方法二</p>
<p>直接在 <a href="https://github.com/tyarkoni/transitions" target="_blank" rel="noopener">GitHub</a> 上clone仓库到本地，然后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>
<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><p>俗话说，接触一个新的工具库，100页的API文档、一千字的描述文档或更多的解释说明都不如一个简单的Demo，虽然这个说法我们无法验证真伪，但下面的例子会让你快速了解 <code>Transitions</code> 的基本用法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">from transitions import Machine</span><br><span class="line">import random</span><br><span class="line"></span><br><span class="line">class NarcolepticSuperhero(object):</span><br><span class="line"></span><br><span class="line">    # Define some states. Most of the time, narcoleptic superheroes are just like</span><br><span class="line">    # everyone else. Except for...</span><br><span class="line">    states = [&apos;asleep&apos;, &apos;hanging out&apos;, &apos;hungry&apos;, &apos;sweaty&apos;, &apos;saving the world&apos;]</span><br><span class="line"></span><br><span class="line">    def __init__(self, name):</span><br><span class="line"></span><br><span class="line">        # No anonymous superheroes on my watch! Every narcoleptic superhero gets</span><br><span class="line">        # a name. Any name at all. SleepyMan. SlumberGirl. You get the idea.</span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">        # What have we accomplished today?</span><br><span class="line">        self.kittens_rescued = 0</span><br><span class="line"></span><br><span class="line">        # Initialize the state machine</span><br><span class="line">        self.machine = Machine(model=self, states=NarcolepticSuperhero.states, initial=&apos;asleep&apos;)</span><br><span class="line"></span><br><span class="line">        # Add some transitions. We could also define these using a static list of</span><br><span class="line">        # dictionaries, as we did with states above, and then pass the list to</span><br><span class="line">        # the Machine initializer as the transitions= argument.</span><br><span class="line"></span><br><span class="line">        # At some point, every superhero must rise and shine.</span><br><span class="line">        self.machine.add_transition(trigger=&apos;wake_up&apos;, source=&apos;asleep&apos;, dest=&apos;hanging out&apos;)</span><br><span class="line"></span><br><span class="line">        # Superheroes need to keep in shape.</span><br><span class="line">        self.machine.add_transition(&apos;work_out&apos;, &apos;hanging out&apos;, &apos;hungry&apos;)</span><br><span class="line"></span><br><span class="line">        # Those calories won&apos;t replenish themselves!</span><br><span class="line">        self.machine.add_transition(&apos;eat&apos;, &apos;hungry&apos;, &apos;hanging out&apos;)</span><br><span class="line"></span><br><span class="line">        # Superheroes are always on call. ALWAYS. But they&apos;re not always</span><br><span class="line">        # dressed in work-appropriate clothing.</span><br><span class="line">        self.machine.add_transition(&apos;distress_call&apos;, &apos;*&apos;, &apos;saving the world&apos;,</span><br><span class="line">                         before=&apos;change_into_super_secret_costume&apos;)</span><br><span class="line"></span><br><span class="line">        # When they get off work, they&apos;re all sweaty and disgusting. But before</span><br><span class="line">        # they do anything else, they have to meticulously log their latest</span><br><span class="line">        # escapades. Because the legal department says so.</span><br><span class="line">        self.machine.add_transition(&apos;complete_mission&apos;, &apos;saving the world&apos;, &apos;sweaty&apos;,</span><br><span class="line">                         after=&apos;update_journal&apos;)</span><br><span class="line"></span><br><span class="line">        # Sweat is a disorder that can be remedied with water.</span><br><span class="line">        # Unless you&apos;ve had a particularly long day, in which case... bed time!</span><br><span class="line">        self.machine.add_transition(&apos;clean_up&apos;, &apos;sweaty&apos;, &apos;asleep&apos;, conditions=[&apos;is_exhausted&apos;])</span><br><span class="line">        self.machine.add_transition(&apos;clean_up&apos;, &apos;sweaty&apos;, &apos;hanging out&apos;)</span><br><span class="line"></span><br><span class="line">        # Our NarcolepticSuperhero can fall asleep at pretty much any time.</span><br><span class="line">        self.machine.add_transition(&apos;nap&apos;, &apos;*&apos;, &apos;asleep&apos;)</span><br><span class="line"></span><br><span class="line">    def update_journal(self):</span><br><span class="line">        &quot;&quot;&quot; Dear Diary, today I saved Mr. Whiskers. Again. &quot;&quot;&quot;</span><br><span class="line">        self.kittens_rescued += 1</span><br><span class="line"></span><br><span class="line">    def is_exhausted(self):</span><br><span class="line">        &quot;&quot;&quot; Basically a coin toss. &quot;&quot;&quot;</span><br><span class="line">        return random.random() &lt; 0.5</span><br><span class="line"></span><br><span class="line">    def change_into_super_secret_costume(self):</span><br><span class="line">        print(&quot;Beauty, eh?&quot;)</span><br></pre></td></tr></table></figure>
<p>现在我们已经建立了一个 <code>NarcolepticSuperhero</code> 状态机，来看看具体怎么使用吧</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; batman = NarcolepticSuperhero(&quot;Batman&quot;)</span><br><span class="line">&gt;&gt;&gt; batman.state</span><br><span class="line">&apos;asleep&apos;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; batman.wake_up()</span><br><span class="line">&gt;&gt;&gt; batman.state</span><br><span class="line">&apos;hanging out&apos;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; batman.nap()</span><br><span class="line">&gt;&gt;&gt; batman.state</span><br><span class="line">&apos;asleep&apos;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; batman.clean_up()</span><br><span class="line">MachineError: &quot;Can&apos;t trigger event clean_up from state asleep!&quot;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; batman.wake_up()</span><br><span class="line">&gt;&gt;&gt; batman.work_out()</span><br><span class="line">&gt;&gt;&gt; batman.state</span><br><span class="line">&apos;hungry&apos;</span><br><span class="line"></span><br><span class="line"># Batman still hasn&apos;t done anything useful...</span><br><span class="line">&gt;&gt;&gt; batman.kittens_rescued</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"># We now take you live to the scene of a horrific kitten entreement...</span><br><span class="line">&gt;&gt;&gt; batman.distress_call()</span><br><span class="line">&apos;Beauty, eh?&apos;</span><br><span class="line">&gt;&gt;&gt; batman.state</span><br><span class="line">&apos;saving the world&apos;</span><br><span class="line"></span><br><span class="line"># Back to the crib.</span><br><span class="line">&gt;&gt;&gt; batman.complete_mission()</span><br><span class="line">&gt;&gt;&gt; batman.state</span><br><span class="line">&apos;sweaty&apos;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; batman.clean_up()</span><br><span class="line">&gt;&gt;&gt; batman.state</span><br><span class="line">&apos;asleep&apos;   # Too tired to shower!</span><br><span class="line"></span><br><span class="line"># Another productive day, Alfred.</span><br><span class="line">&gt;&gt;&gt; batman.kittens_rescued</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
<h2 id="详细文档"><a href="#详细文档" class="headerlink" title="详细文档"></a>详细文档</h2><h3 id="基本初始化方式"><a href="#基本初始化方式" class="headerlink" title="基本初始化方式"></a>基本初始化方式</h3><p>使状态机正常运行非常简单。 假设你有一个对象 <code>lump</code> ( <code>Matter</code> 类的一个实例) ，并且你想要管理它的状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class Matter(object):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">lump = Matter()</span><br></pre></td></tr></table></figure>
<p>我们将 <code>lump</code> 绑定到状态机上来初始化一个<strong>最小状态机</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from transitions import Machine</span><br><span class="line">machine = Machine(model=lump, states=[&apos;solid&apos;, &apos;liquid&apos;, &apos;gas&apos;, &apos;plasma&apos;], initial=&apos;solid&apos;)</span><br><span class="line"></span><br><span class="line"># Lump now has state!</span><br><span class="line">lump.state</span><br><span class="line">&gt;&gt;&gt; &apos;solid&apos;</span><br></pre></td></tr></table></figure>
<p> 之所以称之为<strong>最小状态机</strong>，因为这种状态机在技术上是可操作的，状态机初试状态为 <code>solid</code> ，但因为我们没有增加任何的转移动作(transitions：这应该是个动词，我在这翻译为转移动作)， 所以它实际上什么也没做。</p>
<p>下面我们来定义更多的状态和转移动作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># The states</span><br><span class="line">states=[&apos;solid&apos;, &apos;liquid&apos;, &apos;gas&apos;, &apos;plasma&apos;]</span><br><span class="line"></span><br><span class="line"># And some transitions between states. We&apos;re lazy, so we&apos;ll leave out</span><br><span class="line"># the inverse phase transitions (freezing, condensation, etc.).</span><br><span class="line">transitions = [</span><br><span class="line">    &#123; &apos;trigger&apos;: &apos;melt&apos;, &apos;source&apos;: &apos;solid&apos;, &apos;dest&apos;: &apos;liquid&apos; &#125;,</span><br><span class="line">    &#123; &apos;trigger&apos;: &apos;evaporate&apos;, &apos;source&apos;: &apos;liquid&apos;, &apos;dest&apos;: &apos;gas&apos; &#125;,</span><br><span class="line">    &#123; &apos;trigger&apos;: &apos;sublimate&apos;, &apos;source&apos;: &apos;solid&apos;, &apos;dest&apos;: &apos;gas&apos; &#125;,</span><br><span class="line">    &#123; &apos;trigger&apos;: &apos;ionize&apos;, &apos;source&apos;: &apos;gas&apos;, &apos;dest&apos;: &apos;plasma&apos; &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"># Initialize</span><br><span class="line">machine = Machine(lump, states=states, transitions=transitions, initial=&apos;liquid&apos;)</span><br><span class="line"></span><br><span class="line"># Now lump maintains state...</span><br><span class="line">lump.state</span><br><span class="line">&gt;&gt;&gt; &apos;liquid&apos;</span><br><span class="line"></span><br><span class="line"># And that state can change...</span><br><span class="line">lump.evaporate()</span><br><span class="line">lump.state</span><br><span class="line">&gt;&gt;&gt; &apos;gas&apos;</span><br><span class="line">lump.trigger(&apos;ionize&apos;)</span><br><span class="line">lump.state</span><br><span class="line">&gt;&gt;&gt; &apos;plasma&apos;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：我们为 <code>Matter</code>  实例 <code>lump</code> 绑定了 <code>evaporate()</code>  <code>ionize()</code> 等方法，每个方法触发相应的状态转换，你不必在任何地方明确定义这些方法，每个转换的名称通过绑定到模型上来传递给状态机初始化函数(<code>lump</code>)。<code>evaporate()</code>  <code>ionize()</code>另等方法都是静态来触发状态转移，如果我们想实现动态转移，可以使用<code>trigger</code> 方法。</p>
<h3 id="状态集"><a href="#状态集" class="headerlink" title="状态集"></a>状态集</h3><p>毫无疑问，状态机的核心是状态集，上述介绍中我们通过传递给 <code>Machine</code> 初始化函数字符串列表来定义有效的模型状态，但是在 <code>Machine</code> 内部，状态以 <code>State</code> 对象的形式存储。</p>
<p>我们可以通过多种方式初始化和跟新状态，比如：</p>
<ul>
<li>传递一个给定状态名的字符串给 <code>Machine</code> 初始化函数；</li>
<li>直接初始化每个新的 <code>State</code> 对象；</li>
<li>传递具有初始化参数的字典。</li>
</ul>
<p>以下代码片段说明了实现相同目标的几种方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># Create a list of 3 states to pass to the Machine</span><br><span class="line"># initializer. We can mix types; in this case, we</span><br><span class="line"># pass one State, one string, and one dict.</span><br><span class="line">states = [</span><br><span class="line">    State(name=&apos;solid&apos;),</span><br><span class="line">    &apos;liquid&apos;,</span><br><span class="line">    &#123; &apos;name&apos;: &apos;gas&apos;&#125;</span><br><span class="line">    ]</span><br><span class="line">machine = Machine(lump, states)</span><br><span class="line"></span><br><span class="line"># This alternative example illustrates more explicit</span><br><span class="line"># addition of states and state callbacks, but the net</span><br><span class="line"># result is identical to the above.</span><br><span class="line">machine = Machine(lump)</span><br><span class="line">solid = State(&apos;solid&apos;)</span><br><span class="line">liquid = State(&apos;liquid&apos;)</span><br><span class="line">gas = State(&apos;gas&apos;)</span><br><span class="line">machine.add_states([solid, liquid, gas])</span><br></pre></td></tr></table></figure>
<h4 id="回调方法"><a href="#回调方法" class="headerlink" title="回调方法"></a>回调方法</h4><p>我们可以给一个状态添加一系列的”进入“和”退出“的回调函数，还可以在初始化期间指定回调，或者稍后再添加回调。</p>
<p>为方便起见，每当新的状态被添加到 <code>Machine</code> 中时，方法 <code>on_enter_«state name»</code> 和 <code>on_exit_«state name»</code> 都是在 <code>Machine</code> 上（而不是 <code>Model</code> 上）上动态创建的，并且允许我们动态地添加新的进入和退出回调函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># Our old Matter class, now with  a couple of new methods we</span><br><span class="line"># can trigger when entering or exit states.</span><br><span class="line">class Matter(object):</span><br><span class="line">    def say_hello(self): print(&quot;hello, new state!&quot;)</span><br><span class="line">    def say_goodbye(self): print(&quot;goodbye, old state!&quot;)</span><br><span class="line"></span><br><span class="line">lump = Matter()</span><br><span class="line"></span><br><span class="line"># Same states as above, but now we give StateA an exit callback</span><br><span class="line">states = [</span><br><span class="line">    State(name=&apos;solid&apos;, on_exit=[&apos;say_goodbye&apos;]),</span><br><span class="line">    &apos;liquid&apos;,</span><br><span class="line">    &#123; &apos;name&apos;: &apos;gas&apos; &#125;</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">machine = Machine(lump, states=states)</span><br><span class="line">machine.add_transition(&apos;sublimate&apos;, &apos;solid&apos;, &apos;gas&apos;)</span><br><span class="line"></span><br><span class="line"># Callbacks can also be added after initialization using</span><br><span class="line"># the dynamically added on_enter_ and on_exit_ methods.</span><br><span class="line"># Note that the initial call to add the callback is made</span><br><span class="line"># on the Machine and not on the model.</span><br><span class="line">machine.on_enter_gas(&apos;say_hello&apos;)</span><br><span class="line"></span><br><span class="line"># Test out the callbacks...</span><br><span class="line">machine.set_state(&apos;solid&apos;)</span><br><span class="line">lump.sublimate()</span><br><span class="line">&gt;&gt;&gt; &apos;goodbye, old state!&apos;</span><br><span class="line">&gt;&gt;&gt; &apos;hello, new state!&apos;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：首次初始化状态机时， <code>on_enter_«state name»</code> 回调函数是不会触发的。例如，我们定义了一个回调函数 <code>on_enter_A()</code> ，并给状态机初始化状态为 <code>initial=&#39;A&#39;</code> ，<code>on_enter_A()</code> 会在下次进入状态A的时候出发，首次并不会触发。如果我们想在初始化的时候就触发 <code>on_enter_A()</code> 方法，可以创建一个虚拟的初始状态，然后调用 <code>to_A()</code> 方法，而不是 <code>__init__</code> 方法。 </p>
<p>除了在初始化状态机传递回调或动态添加回调，为增加代码的清晰度，还可以在模型类本身中定义回调。例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Matter(object):</span><br><span class="line">    def say_hello(self): print(&quot;hello, new state!&quot;)</span><br><span class="line">    def say_goodbye(self): print(&quot;goodbye, old state!&quot;)</span><br><span class="line">    def on_enter_A(self): print(&quot;We&apos;ve just entered state A!&quot;)</span><br><span class="line"></span><br><span class="line">lump = Matter()</span><br><span class="line">machine = Machine(lump, states=[&apos;A&apos;, &apos;B&apos;, &apos;C&apos;])</span><br></pre></td></tr></table></figure>
<p>现在，任何时候 <code>lump</code> 转移到状态A，类<code>Matter</code> 中的 <code>on_enter_A()</code> 方法总是会触发。</p>
<h4 id="检查状态"><a href="#检查状态" class="headerlink" title="检查状态"></a>检查状态</h4><p>我们可以随时通过以下方式检查模型的当前状态</p>
<ul>
<li>检查 <code>.state</code> 属性；</li>
<li>调用 <code>is_«state name»()</code>  方法。</li>
</ul>
<p>如果要检索当前状态的实际状态对象，可以通过 <code>Machine</code> 实例的 <code>get_state()</code> 方法来实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lump.state</span><br><span class="line">&gt;&gt;&gt; &apos;solid&apos;</span><br><span class="line">lump.is_gas()</span><br><span class="line">&gt;&gt;&gt; False</span><br><span class="line">lump.is_solid()</span><br><span class="line">&gt;&gt;&gt; True</span><br><span class="line">machine.get_state(lump.state).name</span><br><span class="line">&gt;&gt;&gt; &apos;solid&apos;</span><br></pre></td></tr></table></figure>
<h3 id="状态转换"><a href="#状态转换" class="headerlink" title="状态转换"></a>状态转换</h3><p>上面的一些例子已经说明了状态转移的使用，但是在这里我们将更详细地探讨它们。</p>
<p>与状态一样，每个状态转换在内部用 <code>Transitions</code> 对象来表示，我们可以传递一个字典或字典列表来快速初始化状态转换集合。</p>
<p>如上面我们已经写过的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">transitions = [</span><br><span class="line">    &#123; &apos;trigger&apos;: &apos;melt&apos;, &apos;source&apos;: &apos;solid&apos;, &apos;dest&apos;: &apos;liquid&apos; &#125;,</span><br><span class="line">    &#123; &apos;trigger&apos;: &apos;evaporate&apos;, &apos;source&apos;: &apos;liquid&apos;, &apos;dest&apos;: &apos;gas&apos; &#125;,</span><br><span class="line">    &#123; &apos;trigger&apos;: &apos;sublimate&apos;, &apos;source&apos;: &apos;solid&apos;, &apos;dest&apos;: &apos;gas&apos; &#125;,</span><br><span class="line">    &#123; &apos;trigger&apos;: &apos;ionize&apos;, &apos;source&apos;: &apos;gas&apos;, &apos;dest&apos;: &apos;plasma&apos; &#125;</span><br><span class="line">]</span><br><span class="line">machine = Machine(model=Matter(), states=states, transitions=transitions)</span><br></pre></td></tr></table></figure>
<p>使用字典定义转换有利于代码的清晰，但显得比较笨重。比较简单的方法是使用列表定义转换，只需确保每个列表中的元素与 <code>Transition</code> 初始化中的位置参数的顺序相同(比如 <code>trigger</code>, <code>source</code>, <code>destination</code> 等)</p>
<p>我们可以这样定义转换</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">transitions = [</span><br><span class="line">    [&apos;melt&apos;, &apos;solid&apos;, &apos;liquid&apos;],</span><br><span class="line">    [&apos;evaporate&apos;, &apos;liquid&apos;, &apos;gas&apos;],</span><br><span class="line">    [&apos;sublimate&apos;, &apos;solid&apos;, &apos;gas&apos;],</span><br><span class="line">    [&apos;ionize&apos;, &apos;gas&apos;, &apos;plasma&apos;]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>另外，我们也可以在状态机初始化之后添加转换</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">machine = Machine(model=lump, states=states, initial=&apos;solid&apos;)</span><br><span class="line">machine.add_transition(&apos;melt&apos;, source=&apos;solid&apos;, dest=&apos;liquid&apos;)</span><br></pre></td></tr></table></figure>
<p> <code>trigger</code> 参数定义了绑定到模型上的触发方法的名称，当回调这个方法的时候，状态机会执行相应的状态转换。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; lump.melt()</span><br><span class="line">&gt;&gt;&gt; lump.state</span><br><span class="line">&apos;liquid&apos;</span><br></pre></td></tr></table></figure>
<p>当我们调用非法的转换时，<code>Machine</code> 会抛出异常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; lump.to_gas()</span><br><span class="line">&gt;&gt;&gt; # This won&apos;t work because only objects in a solid state can melt</span><br><span class="line">&gt;&gt;&gt; lump.melt()</span><br><span class="line">transitions.core.MachineError: &quot;Can&apos;t trigger event melt from state gas!&quot;</span><br></pre></td></tr></table></figure>
<p>这种做法通常是可取的，因为它有助于提醒代码中的问题。但是在某些情况下，我们希望忽略这些非法转换，这时可以设置 <code>ignore_invalid_triggers=True</code> (可以全部忽略，也可忽略特定一条)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; # Globally suppress invalid trigger exceptions</span><br><span class="line">&gt;&gt;&gt; m = Machine(lump, states, initial=&apos;solid&apos;, ignore_invalid_triggers=True)</span><br><span class="line">&gt;&gt;&gt; # ...or suppress for only one group of states</span><br><span class="line">&gt;&gt;&gt; states = [&apos;new_state1&apos;, &apos;new_state2&apos;]</span><br><span class="line">&gt;&gt;&gt; m.add_states(states, ignore_invalid_triggers=True)</span><br><span class="line">&gt;&gt;&gt; # ...or even just for a single state. Here, exceptions will only be suppressed when the current state is A.</span><br><span class="line">&gt;&gt;&gt; states = [State(&apos;A&apos;, ignore_invalid_triggers=True), &apos;B&apos;, &apos;C&apos;]</span><br><span class="line">&gt;&gt;&gt; m = Machine(lump, states)</span><br></pre></td></tr></table></figure>
<p>如果在做状态转换之前，希望知道在当前状态下，哪些是合法的转换，可以使用 <code>get_triggers()</code> 方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">m.get_triggers(&apos;solid&apos;)</span><br><span class="line">&gt;&gt;&gt; [&apos;melt&apos;, &apos;sublimate&apos;]</span><br><span class="line">m.get_triggers(&apos;liquid&apos;)</span><br><span class="line">&gt;&gt;&gt; [&apos;evaporate&apos;]</span><br><span class="line">m.get_triggers(&apos;plasma&apos;)</span><br><span class="line">&gt;&gt;&gt; []</span><br><span class="line"># you can also query several states at once</span><br><span class="line">m.get_triggers(&apos;solid&apos;, &apos;liquid&apos;, &apos;gas&apos;, &apos;plasma&apos;)</span><br><span class="line">&gt;&gt;&gt; [&apos;melt&apos;, &apos;evaporate&apos;, &apos;sublimate&apos;, &apos;ionize&apos;]</span><br></pre></td></tr></table></figure>
<h4 id="自动转换所有状态"><a href="#自动转换所有状态" class="headerlink" title="自动转换所有状态"></a>自动转换所有状态</h4><p>除了显式添加的任何转换之外，每当将状态添加到 <code>Machine</code> 实例时，都会自动创建一个 <code>to_«state»()</code> 方法，该方法无论状态机当前处于哪种状态，都会转换到目标状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lump.to_liquid()</span><br><span class="line">lump.state</span><br><span class="line">&gt;&gt;&gt; &apos;liquid&apos;</span><br><span class="line">lump.to_solid()</span><br><span class="line">lump.state</span><br><span class="line">&gt;&gt;&gt; &apos;solid&apos;</span><br></pre></td></tr></table></figure>
<p>我们可以在状态机初始化的时候设置 <code>auto_transitions=False</code> 禁用这个功能。</p>
<h4 id="多状态转换"><a href="#多状态转换" class="headerlink" title="多状态转换"></a>多状态转换</h4><p>给定的触发器可以附加到多个转换，其中一些可以在相同的状态下潜在地开始或结束。比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">machine.add_transition(&apos;transmogrify&apos;, [&apos;solid&apos;, &apos;liquid&apos;, &apos;gas&apos;], &apos;plasma&apos;)</span><br><span class="line">machine.add_transition(&apos;transmogrify&apos;, &apos;plasma&apos;, &apos;solid&apos;)</span><br><span class="line"># This next transition will never execute</span><br><span class="line">machine.add_transition(&apos;transmogrify&apos;, &apos;plasma&apos;, &apos;gas&apos;)</span><br></pre></td></tr></table></figure>
<p>在这种情况下，如果当前状态是 <code>plasma</code> 调用 <code>transmogrify()</code> ，会转换到 <code>solid</code> 状态，然后继续转换到 <code>plasma</code> 状态。<strong>注意</strong>：只有第一个匹配的转换将执行，因此，上述最后一行中定义的转换将不会做任何事情。</p>
<p>我们还可以通过使用 <code>*</code> 通配符来引发触发器从所有状态转换到特定状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">machine.add_transition(&apos;to_liquid&apos;, &apos;*&apos;, &apos;liquid&apos;)</span><br></pre></td></tr></table></figure>
<p>一个反身触发（触发器具有与源和目标相同的状态）可以使用“=”来表示目的状态，比如通过 <code>touch</code> 触发，<code>solid</code> 的目标状态为自身。如果我们希望同一个反身触发器应用到多个状态中，使用“=”是比较方便的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">machine.add_transition(&apos;touch&apos;, [&apos;liquid&apos;, &apos;gas&apos;, &apos;plasma&apos;], &apos;=&apos;, after=&apos;change_shape&apos;)</span><br></pre></td></tr></table></figure>
<p>通过上面的语句， <code>&#39;liquid&#39;, &#39;gas&#39;, &#39;plasma&#39;</code> 三个状态通过 <code>touch</code> 触发器，可以到达的目的状态分别是 <code>&#39;liquid&#39;, &#39;gas&#39;, &#39;plasma&#39;</code> 。</p>
<h4 id="有序转换"><a href="#有序转换" class="headerlink" title="有序转换"></a>有序转换</h4><p>比如我们现在有这样一个需求，状态的转换是遵循自定义的序列的，如给定状态 <code>[&#39;A&#39;, &#39;B&#39;, &#39;C&#39;]</code>，我们可能需要这样的状态转换 <code>A → B, B → C, C → A</code> （没有其他的非法转换）。为了实现这个功能，<code>Transitions</code> 在 <code>Machine</code> 类中提供了 <code>add_ordered_transitions()</code> 方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">states = [&apos;A&apos;, &apos;B&apos;, &apos;C&apos;]</span><br><span class="line"> # See the &quot;alternative initialization&quot; section for an explanation of the 1st argument to init</span><br><span class="line">machine = Machine(states=states, initial=&apos;A&apos;)</span><br><span class="line">machine.add_ordered_transitions()</span><br><span class="line">machine.next_state()</span><br><span class="line">print(machine.state)</span><br><span class="line">&gt;&gt;&gt; &apos;B&apos;</span><br><span class="line"># We can also define a different order of transitions</span><br><span class="line">machine = Machine(states=states, initial=&apos;A&apos;)</span><br><span class="line">machine.add_ordered_transitions([&apos;A&apos;, &apos;C&apos;, &apos;B&apos;])</span><br><span class="line">machine.next_state()</span><br><span class="line">print(machine.state)</span><br><span class="line">&gt;&gt;&gt; &apos;C&apos;</span><br></pre></td></tr></table></figure>
<h4 id="排队转换"><a href="#排队转换" class="headerlink" title="排队转换"></a>排队转换</h4><p>Transitions中的默认行为是立即处理事件。也就是说，调用绑定在 <code>after</code> 上的回调函数之前， <code>on_enter</code> 方法中的事件会预先处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">def go_to_C():</span><br><span class="line">    global machine</span><br><span class="line">    machine.to_C()</span><br><span class="line"></span><br><span class="line">def after_advance():</span><br><span class="line">    print(&quot;I am in state B now!&quot;)</span><br><span class="line"></span><br><span class="line">def entering_C():</span><br><span class="line">    print(&quot;I am in state C now!&quot;)</span><br><span class="line"></span><br><span class="line">states = [&apos;A&apos;, &apos;B&apos;, &apos;C&apos;]</span><br><span class="line">machine = Machine(states=states)</span><br><span class="line"></span><br><span class="line"># we want a message when state transition to B has been completed</span><br><span class="line">machine.add_transition(&apos;advance&apos;, &apos;A&apos;, &apos;B&apos;, after=after_advance)</span><br><span class="line"></span><br><span class="line"># call transition from state B to state C</span><br><span class="line">machine.on_enter_B(go_to_C)</span><br><span class="line"></span><br><span class="line"># we also want a message when entering state C</span><br><span class="line">machine.on_enter_C(entering_C)</span><br><span class="line">machine.advance()</span><br><span class="line">&gt;&gt;&gt; &apos;I am in state C now!&apos;</span><br><span class="line">&gt;&gt;&gt; &apos;I am in state B now!&apos; # what?</span><br></pre></td></tr></table></figure>
<p>上述状态机的执行顺序为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prepare -&gt; before -&gt; on_enter_B -&gt; on_enter_C -&gt; after.</span><br></pre></td></tr></table></figure>
<p>如果启用排队处理，则在触发下一个转换之前，转换将完成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">machine = Machine(states=states, queued=True)</span><br><span class="line">...</span><br><span class="line">machine.advance()</span><br><span class="line">&gt;&gt;&gt; &apos;I am in state B now!&apos;</span><br><span class="line">&gt;&gt;&gt; &apos;I am in state C now!&apos; # That&apos;s better!</span><br></pre></td></tr></table></figure>
<p>执行顺序为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prepare -&gt; before -&gt; on_enter_B -&gt; queue(to_C) -&gt; after  -&gt; on_enter_C.</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：当使用排队处理事件时，触发器的调用始终返回True，所以在排队执行过程中，无法确定一个包含排队回调函数的转换最终是否能成功，即使是在处理一个事件的时候。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">machine.add_transition(&apos;jump&apos;, &apos;A&apos;, &apos;C&apos;, conditions=&apos;will_fail&apos;)</span><br><span class="line">...</span><br><span class="line"># queued=False</span><br><span class="line">machine.jump()</span><br><span class="line">&gt;&gt;&gt; False</span><br><span class="line"># queued=True</span><br><span class="line">machine.jump()</span><br><span class="line">&gt;&gt;&gt; True</span><br></pre></td></tr></table></figure>
<h4 id="条件转换"><a href="#条件转换" class="headerlink" title="条件转换"></a>条件转换</h4><p>在某些情况下，我们可能需要在某些条件成立的时候去执行特定的转换，这个时候，<code>conditions</code> 就派上用场了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Our Matter class, now with a bunch of methods that return booleans.</span><br><span class="line">class Matter(object):</span><br><span class="line">    def is_flammable(self): return False</span><br><span class="line">    def is_really_hot(self): return True</span><br><span class="line"></span><br><span class="line">machine.add_transition(&apos;heat&apos;, &apos;solid&apos;, &apos;gas&apos;, conditions=&apos;is_flammable&apos;)</span><br><span class="line">machine.add_transition(&apos;heat&apos;, &apos;solid&apos;, &apos;liquid&apos;, conditions=[&apos;is_really_hot&apos;])</span><br></pre></td></tr></table></figure>
<p>在上面的示例中，如果模型初始化的状态为 <code>solid</code> ，当条件 <code>is_flammable</code> 成立时，调用 <code>heat()</code> 会转换到 <code>gas</code> 状态。同样，如果条件 <code>is_really_hot</code> 成立，调用 <code>heat()</code> 会转换到 <code>liquid</code> 状态。</p>
<p>我们还可能在某些条件不成立的条件下，转换到另一状态，<code>Transitions</code> 为我们提供了 <code>unless</code> 方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">machine.add_transition(&apos;heat&apos;, &apos;solid&apos;, &apos;gas&apos;, unless=[&apos;is_flammable&apos;, &apos;is_really_hot&apos;])</span><br></pre></td></tr></table></figure>
<p>这时，如果 <code>is_flammable(), is_really_hot()</code> 返回的都是 <code>False</code> ，模型调用 <code>heat()</code> 会从 <code>solid</code> 转换到 <code>gas</code> 状态。</p>
<p><strong>注意</strong>：条件检查方法会被动接收传递给触发函数的参数或数据对象。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lump.heat(temp=74)</span><br><span class="line"># equivalent to lump.trigger(&apos;heat&apos;, temp=74)</span><br></pre></td></tr></table></figure>
<p>这样会将 <code>temp=74</code> 的可选参数传递给 <code>is_flammable()</code> 方法（以 <code>EventData</code> 实例的方式），参数的传递我们在后面会介绍。</p>
<h4 id="回调方法-1"><a href="#回调方法-1" class="headerlink" title="回调方法"></a>回调方法</h4><p>我们可以将回调方法绑定到状态集和转换集上，每一个转换都包含 <code>before</code> 和 <code>after</code> 属性，这也是我们比较常用的，这两个属性包含了一系列在状态转换前后可以调用的方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class Matter(object):</span><br><span class="line">    def make_hissing_noises(self): print(&quot;HISSSSSSSSSSSSSSSS&quot;)</span><br><span class="line">    def disappear(self): print(&quot;where&apos;d all the liquid go?&quot;)</span><br><span class="line"></span><br><span class="line">transitions = [</span><br><span class="line">    &#123; &apos;trigger&apos;: &apos;melt&apos;, &apos;source&apos;: &apos;solid&apos;, &apos;dest&apos;: &apos;liquid&apos;, &apos;before&apos;: &apos;make_hissing_noises&apos;&#125;,</span><br><span class="line">    &#123; &apos;trigger&apos;: &apos;evaporate&apos;, &apos;source&apos;: &apos;liquid&apos;, &apos;dest&apos;: &apos;gas&apos;, &apos;after&apos;: &apos;disappear&apos; &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">lump = Matter()</span><br><span class="line">machine = Machine(lump, states, transitions=transitions, initial=&apos;solid&apos;)</span><br><span class="line">lump.melt()</span><br><span class="line">&gt;&gt;&gt; &quot;HISSSSSSSSSSSSSSSS&quot;</span><br><span class="line">lump.evaporate()</span><br><span class="line">&gt;&gt;&gt; &quot;where&apos;d all the liquid go?&quot;</span><br></pre></td></tr></table></figure>
<p>在状态转换一开始，在其他转换开始执行之前，我们也可以使用 <code>prepare</code> 回调函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">class Matter(object):</span><br><span class="line">    heat = False</span><br><span class="line">    attempts = 0</span><br><span class="line">    def count_attempts(self): self.attempts += 1</span><br><span class="line">    def is_really_hot(self): return self.heat</span><br><span class="line">    def heat_up(self): self.heat = random.random() &lt; 0.25</span><br><span class="line">    def stats(self): print(&apos;It took you %i attempts to melt the lump!&apos; %self.attempts)</span><br><span class="line"></span><br><span class="line">states=[&apos;solid&apos;, &apos;liquid&apos;, &apos;gas&apos;, &apos;plasma&apos;]</span><br><span class="line"></span><br><span class="line">transitions = [</span><br><span class="line">    &#123; &apos;trigger&apos;: &apos;melt&apos;, &apos;source&apos;: &apos;solid&apos;, &apos;dest&apos;: &apos;liquid&apos;, &apos;prepare&apos;: [&apos;heat_up&apos;, &apos;count_attempts&apos;], &apos;conditions&apos;: &apos;is_really_hot&apos;, &apos;after&apos;: &apos;stats&apos;&#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">lump = Matter()</span><br><span class="line">machine = Machine(lump, states, transitions=transitions, initial=&apos;solid&apos;)</span><br><span class="line">lump.melt()</span><br><span class="line">lump.melt()</span><br><span class="line">lump.melt()</span><br><span class="line">lump.melt()</span><br><span class="line">&gt;&gt;&gt; &quot;It took you 4 attempts to melt the lump!&quot;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：除非当前状态是定义在转换集上有效的状态，否则，<code>prepare</code> 回调是不会起作用的。</p>
<p>如果在每一个转换执行之前或之后都需要进行一些默认操作，我们可以在状态机初始化的时候显示使用 <code>before_state_change</code>  和 <code>after_state_change</code>  属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class Matter(object):</span><br><span class="line">    def make_hissing_noises(self): print(&quot;HISSSSSSSSSSSSSSSS&quot;)</span><br><span class="line">    def disappear(self): print(&quot;where&apos;d all the liquid go?&quot;)</span><br><span class="line"></span><br><span class="line">states=[&apos;solid&apos;, &apos;liquid&apos;, &apos;gas&apos;, &apos;plasma&apos;]</span><br><span class="line"></span><br><span class="line">lump = Matter()</span><br><span class="line">m = Machine(lump, states, before_state_change=&apos;make_hissing_noises&apos;, after_state_change=&apos;disappear&apos;)</span><br><span class="line">lump.to_gas()</span><br><span class="line">&gt;&gt;&gt; &quot;HISSSSSSSSSSSSSSSS&quot;</span><br><span class="line">&gt;&gt;&gt; &quot;where&apos;d all the liquid go?&quot;</span><br></pre></td></tr></table></figure>
<p>还有一些可以独立使用的关键字：</p>
<ul>
<li><code>prepare_event</code> ：通过 <code>prepare_event</code> 关键字传递给状态机的回调方法，在处理可能发生的状态转换（包括私有的 <code>prepare</code> 回调方法）之前，仅执行一次；</li>
<li><code>finalize_event</code> ：通过 <code>finalize_event</code> 关键字传递给状态机的回调方法，不管转换是否成功，都会被执行；</li>
<li><code>send_event</code> ：如果在状态转换过程中出现了错误，这个错误会绑定到 <code>event_data</code> 上，我们可以使用 <code>send_event=True</code> 来检索错误 。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">from transitions import Machine</span><br><span class="line"></span><br><span class="line">class Matter(object):</span><br><span class="line">    def raise_error(self, event): raise ValueError(&quot;Oh no&quot;)</span><br><span class="line">    def prepare(self, event): print(&quot;I am ready!&quot;)</span><br><span class="line">    def finalize(self, event): print(&quot;Result: &quot;, type(event.error), event.error)</span><br><span class="line"></span><br><span class="line">states=[&apos;solid&apos;, &apos;liquid&apos;, &apos;gas&apos;, &apos;plasma&apos;]</span><br><span class="line"></span><br><span class="line">lump = Matter()</span><br><span class="line">m = Machine(lump, states, prepare_event=&apos;prepare&apos;, before_state_change=&apos;raise_error&apos;,</span><br><span class="line">            finalize_event=&apos;finalize&apos;, send_event=True)</span><br><span class="line">try:</span><br><span class="line">    lump.to_gas()</span><br><span class="line">except ValueError:</span><br><span class="line">    pass</span><br><span class="line">print(lump.state)</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; I am ready!</span><br><span class="line">&gt;&gt;&gt; Result:  &lt;class &apos;ValueError&apos;&gt; Oh no</span><br><span class="line">&gt;&gt;&gt; initial</span><br></pre></td></tr></table></figure>
<h3 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h3><p>以下是转换集上回调方法可以执行的命令：</p>
<table>
<thead>
<tr>
<th>回调</th>
<th>状态</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>machine.prepare_event</code></td>
<td>源状态</td>
<td>在私有转换执行之前仅执行一次</td>
</tr>
<tr>
<td><code>transition.prepare</code></td>
<td>源状态</td>
<td>转换一开始就执行</td>
</tr>
<tr>
<td><code>transition.conditions</code></td>
<td>源状态</td>
<td>可使转换失败或停止</td>
</tr>
<tr>
<td><code>transition.unless</code></td>
<td>源状态</td>
<td>可使转换失败或停止</td>
</tr>
<tr>
<td><code>machine.before_state_change</code></td>
<td>源状态</td>
<td>声明在模型上的默认回调方法</td>
</tr>
<tr>
<td><code>transition.before</code></td>
<td>源状态</td>
<td></td>
</tr>
<tr>
<td><code>state.on_exit</code></td>
<td>源状态</td>
<td>声明在源状态上的回调方法</td>
</tr>
<tr>
<td><code>&lt;STATE CHANGE&gt;</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>state.on_enter</code></td>
<td>目的状态</td>
<td>声明在目的状态上的回调方法</td>
</tr>
<tr>
<td><code>transition.after</code></td>
<td>目的状态</td>
<td></td>
</tr>
<tr>
<td><code>machine.after_state_change</code></td>
<td>目的状态</td>
<td>声明在模型上的默认回调方法</td>
</tr>
<tr>
<td><code>machine.finalize_event</code></td>
<td>源状态/目的状态</td>
<td>即使出现错误或异常，回调方法也会执行</td>
</tr>
</tbody>
</table>
<h3 id="传递数据"><a href="#传递数据" class="headerlink" title="传递数据"></a>传递数据</h3><p>在大多数情况下，我们需要传递给注册在状态机中的回调方法一些参数，来反应当前模型的状态和进行一些必要计算。<code>Transitions</code> 提供了两种方法。</p>
<p>第一种方法（默认方法）：</p>
<p>我们可以直接传递参数给触发器方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">class Matter(object):</span><br><span class="line">    def __init__(self): self.set_environment()</span><br><span class="line">    def set_environment(self, temp=0, pressure=101.325):</span><br><span class="line">        self.temp = temp</span><br><span class="line">        self.pressure = pressure</span><br><span class="line">    def print_temperature(self): print(&quot;Current temperature is %d degrees celsius.&quot; % self.temp)</span><br><span class="line">    def print_pressure(self): print(&quot;Current pressure is %.2f kPa.&quot; % self.pressure)</span><br><span class="line"></span><br><span class="line">lump = Matter()</span><br><span class="line">machine = Machine(lump, [&apos;solid&apos;, &apos;liquid&apos;], initial=&apos;solid&apos;)</span><br><span class="line">machine.add_transition(&apos;melt&apos;, &apos;solid&apos;, &apos;liquid&apos;, before=&apos;set_environment&apos;)</span><br><span class="line"></span><br><span class="line">lump.melt(45)  # positional arg;</span><br><span class="line"># equivalent to lump.trigger(&apos;melt&apos;, 45)</span><br><span class="line">lump.print_temperature()</span><br><span class="line">&gt;&gt;&gt; &apos;Current temperature is 45 degrees celsius.&apos;</span><br><span class="line"></span><br><span class="line">machine.set_state(&apos;solid&apos;)  # reset state so we can melt again</span><br><span class="line">lump.melt(pressure=300.23)  # keyword args also work</span><br><span class="line">lump.print_pressure()</span><br><span class="line">&gt;&gt;&gt; &apos;Current pressure is 300.23 kPa.&apos;</span><br></pre></td></tr></table></figure>
<p>我们通过这种方法传递任何参数给触发器方法。</p>
<p>但是这种方式有一种局限性：状态转换触发的每一个回调方法都必须处理所有的参数。如果我们的不同回调方法需要不同的参数，这样就会导致一些不必要的麻烦。</p>
<p>为了解决这个问题，<code>Transitions</code> 提供了另一种方法，上文中我们提到过，参数可以以<code>EventData</code> 实例的方式传递。在<code>Machine</code> 初始化的时候设置 <code>send_event=True</code> ，这样，所有传递给非触发器的参数都以<code>EventData</code> 实例的方式传递给回调方法，为了方便我们随时访问与事件相关的源状态、模型、转换、触发等参数，<code>EventData</code> 实例会维护这些参数的内部引用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">class Matter(object):</span><br><span class="line"></span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.temp = 0</span><br><span class="line">        self.pressure = 101.325</span><br><span class="line"></span><br><span class="line">    # Note that the sole argument is now the EventData instance.</span><br><span class="line">    # This object stores positional arguments passed to the trigger method in the</span><br><span class="line">    # .args property, and stores keywords arguments in the .kwargs dictionary.</span><br><span class="line">    def set_environment(self, event):</span><br><span class="line">        self.temp = event.kwargs.get(&apos;temp&apos;, 0)</span><br><span class="line">        self.pressure = event.kwargs.get(&apos;pressure&apos;, 101.325)</span><br><span class="line"></span><br><span class="line">    def print_pressure(self): print(&quot;Current pressure is %.2f kPa.&quot; % self.pressure)</span><br><span class="line"></span><br><span class="line">lump = Matter()</span><br><span class="line">machine = Machine(lump, [&apos;solid&apos;, &apos;liquid&apos;], send_event=True, initial=&apos;solid&apos;)</span><br><span class="line">machine.add_transition(&apos;melt&apos;, &apos;solid&apos;, &apos;liquid&apos;, before=&apos;set_environment&apos;)</span><br><span class="line"></span><br><span class="line">lump.melt(temp=45, pressure=1853.68)  # keyword args</span><br><span class="line">lump.print_pressure()</span><br><span class="line">&gt;&gt;&gt; &apos;Current pressure is 1853.68 kPa.&apos;</span><br></pre></td></tr></table></figure>
<h3 id="其他初始化方式"><a href="#其他初始化方式" class="headerlink" title="其他初始化方式"></a>其他初始化方式</h3><p>在以上所有的示例中，我们将新的 <code>Machine</code> 实例绑定到一个单独的模型上（<code>Matter</code> 类的实例 <code>lump</code>），虽然这种方式可以使我们的类和回调方法比较整洁，但是我们必须能跟踪到状态机上调用的方法，并且知道模型调用的这些方法绑定了哪个状态机（比如： <code>lump.on_enter_StateA()</code> vs <code>machine.add_transition()</code>）</p>
<p>庆幸的是，<code>Transitions</code> 为我们提供了两种不同的初始化方式。</p>
<p>第一种方式，我们可以创建一个独立的状态机，完全不需要其他模型，在初始化的时候忽略模型参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">machine = Machine(states=states, transitions=transitions, initial=&apos;solid&apos;)</span><br><span class="line">machine.melt()</span><br><span class="line">machine.state</span><br><span class="line">&gt;&gt;&gt; &apos;liquid&apos;</span><br></pre></td></tr></table></figure>
<p>如果我们使用这种方式初始化状态机，我们就可以直接绑定所有的触发事件和回调方法到 <code>Machine</code> 实例上。</p>
<p>这种方法有利于在一个地方整合所有的状态机功能，但如果考虑到状态逻辑应该包含在模型本身中，而不是单独出来，这种方式恐怕也不是最好的。</p>
<p>一种替代的办法是让 <code>Machine</code> 要绑定的模型继承 <code>Machine</code> 类，只要重写 <code>Machine</code> 的 <code>__init__()</code> 方法即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class Matter(Machine):</span><br><span class="line">    def say_hello(self): print(&quot;hello, new state!&quot;)</span><br><span class="line">    def say_goodbye(self): print(&quot;goodbye, old state!&quot;)</span><br><span class="line"></span><br><span class="line">    def __init__(self):</span><br><span class="line">        states = [&apos;solid&apos;, &apos;liquid&apos;, &apos;gas&apos;]</span><br><span class="line">        Machine.__init__(self, states=states, initial=&apos;solid&apos;)</span><br><span class="line">        self.add_transition(&apos;melt&apos;, &apos;solid&apos;, &apos;liquid&apos;)</span><br><span class="line"></span><br><span class="line">lump = Matter()</span><br><span class="line">lump.state</span><br><span class="line">&gt;&gt;&gt; &apos;solid&apos;</span><br><span class="line">lump.melt()</span><br><span class="line">lump.state</span><br><span class="line">&gt;&gt;&gt; &apos;liquid&apos;</span><br></pre></td></tr></table></figure>
<p>现在我们已经整合所有的状态机功能到 <code>lump</code> 模型中，这比将功能独立出来让人感觉更舒服。</p>
<p>如果我们绑定多个模型到 <code>Machine</code> 中，状态机也是可以处理的。如果想要添加模型和 <code>Machine</code> 实例本身，我们可以在初始化的时候使用 <code>self</code> 关键字（ <code>Machine(model=[&#39;self&#39;, model1, ...])</code>），也可以创建一个单独的状态机，然后通过 <code>machine.add_model</code> 动态注册模型到状态机中，如果模型不再使用的情况下，应该调用  <code>machine.remove_model</code>  来回收模型。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class Matter():</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">lump1 = Matter()</span><br><span class="line">lump2 = Matter()</span><br><span class="line"></span><br><span class="line">machine = Machine(states=states, transitions=transitions, initial=&apos;solid&apos;, add_self=False)</span><br><span class="line"></span><br><span class="line">machine.add_model(lump1)</span><br><span class="line">machine.add_model(lump2, initial=&apos;liquid&apos;)</span><br><span class="line"></span><br><span class="line">lump1.state</span><br><span class="line">&gt;&gt;&gt; &apos;solid&apos;</span><br><span class="line">lump2.state</span><br><span class="line">&gt;&gt;&gt; &apos;liquid&apos;</span><br><span class="line"></span><br><span class="line">machine.remove_model([lump1, lump2])</span><br><span class="line">del lump1  # lump1 is garbage collected</span><br><span class="line">del lump2  # lump2 is garbage collected</span><br></pre></td></tr></table></figure>
<p>如果在状态机初始化的时候没有提供初始状态，在添加模型的时候就必须提供这个初始状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">machine = Machine(states=states, transitions=transitions, add_self=False)</span><br><span class="line"></span><br><span class="line">machine.add_model(Matter())</span><br><span class="line">&gt;&gt;&gt; &quot;MachineError: No initial state configured for machine, must specify when adding model.&quot;</span><br><span class="line">machine.add_model(Matter(), initial=&apos;liquid&apos;)</span><br></pre></td></tr></table></figure>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p><code>Transitions</code> 提供一些基本的日志功能，使用 <code>Python</code> 标准的 <code>logging</code> 模块将一些如状态转换、转换触发、条件检查等信息作为 <code>INFO</code> 级别的信息记录下来，我们可以在脚本中轻松地将日志记录配置为标准输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Set up logging</span><br><span class="line">import logging</span><br><span class="line">from transitions import logger</span><br><span class="line">logger.setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line"># Business as usual</span><br><span class="line">machine = Machine(states=states, transitions=transitions, initial=&apos;solid&apos;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="存储-恢复状态机实例"><a href="#存储-恢复状态机实例" class="headerlink" title="存储/恢复状态机实例"></a>存储/恢复状态机实例</h3><p>如果想要存储或加载状态机，必须使用<code>Python3.3</code> 或较早版本的 <code>dill</code> 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import dill as pickle # only required for Python 3.3 and earlier</span><br><span class="line"></span><br><span class="line">m = Machine(states=[&apos;A&apos;, &apos;B&apos;, &apos;C&apos;], initial=&apos;A&apos;)</span><br><span class="line">m.to_B()</span><br><span class="line">m.state  </span><br><span class="line">&gt;&gt;&gt; B</span><br><span class="line"></span><br><span class="line"># store the machine</span><br><span class="line">dump = pickle.dumps(m)</span><br><span class="line"></span><br><span class="line"># load the Machine instance again</span><br><span class="line">m2 = pickle.loads(dump)</span><br><span class="line"></span><br><span class="line">m2.state</span><br><span class="line">&gt;&gt;&gt; B</span><br><span class="line"></span><br><span class="line">m2.states.keys()</span><br><span class="line">&gt;&gt;&gt; [&apos;A&apos;, &apos;B&apos;, &apos;C&apos;]</span><br></pre></td></tr></table></figure>
<p>以上介绍了 <code>Transitions</code> 的基本使用方法，手工翻译难免有些晦涩难懂之处，敬请谅解。除了这些基本用法之外，<code>Transitions</code> 还提供了一些扩展方法，比如图表可视化机器的当前状态、用于嵌套和重用的分层状态机、并行执行的线程安全锁等，这里暂时就不介绍了，先欠着吧，等以后深入使用 <code>Transitions</code> 库的时候再去学习。</p>
<p><code>Transitions</code> 英文完整版介绍请移步 <a href="https://github.com/tyarkoni/transitions" target="_blank" rel="noopener">Transitions</a> </p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Python/" rel="tag"># Python</a>
          
            <a href="/tags/Transitions/" rel="tag"># Transitions</a>
          
            <a href="/tags/状态机库/" rel="tag"># 状态机库</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/05/20/badtasteofcode/" rel="next" title="重构改善既有代码的设计-代码的坏味道">
                <i class="fa fa-chevron-left"></i> 重构改善既有代码的设计-代码的坏味道
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/07/linuxtop/" rel="prev" title="Linux命令-top">
                Linux命令-top <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yOTIyOS81Nzk2"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="william">
          <p class="site-author-name" itemprop="name">william</p>
           
              <p class="site-description motion-element" itemprop="description">删繁就简 一心一意</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">84</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">34</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">129</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/runnerliu" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/violetcoconut" target="_blank" title="weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/liuxiaoyang" target="_blank" title="zhihu">
                  
                    <i class="fa fa-fw fa-hand-o-right"></i>
                  
                  zhihu
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.ezlippi.com/" title="EZLippi-浮生志" target="_blank">EZLippi-浮生志</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Transitions"><span class="nav-number">1.</span> <span class="nav-text">Transitions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装方法"><span class="nav-number">2.</span> <span class="nav-text">安装方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#快速入门"><span class="nav-number">3.</span> <span class="nav-text">快速入门</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#详细文档"><span class="nav-number">4.</span> <span class="nav-text">详细文档</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本初始化方式"><span class="nav-number">4.1.</span> <span class="nav-text">基本初始化方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态集"><span class="nav-number">4.2.</span> <span class="nav-text">状态集</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#回调方法"><span class="nav-number">4.2.1.</span> <span class="nav-text">回调方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查状态"><span class="nav-number">4.2.2.</span> <span class="nav-text">检查状态</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态转换"><span class="nav-number">4.3.</span> <span class="nav-text">状态转换</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#自动转换所有状态"><span class="nav-number">4.3.1.</span> <span class="nav-text">自动转换所有状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多状态转换"><span class="nav-number">4.3.2.</span> <span class="nav-text">多状态转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#有序转换"><span class="nav-number">4.3.3.</span> <span class="nav-text">有序转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#排队转换"><span class="nav-number">4.3.4.</span> <span class="nav-text">排队转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#条件转换"><span class="nav-number">4.3.5.</span> <span class="nav-text">条件转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#回调方法-1"><span class="nav-number">4.3.6.</span> <span class="nav-text">回调方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行命令"><span class="nav-number">4.4.</span> <span class="nav-text">执行命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#传递数据"><span class="nav-number">4.5.</span> <span class="nav-text">传递数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他初始化方式"><span class="nav-number">4.6.</span> <span class="nav-text">其他初始化方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志"><span class="nav-number">4.7.</span> <span class="nav-text">日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存储-恢复状态机实例"><span class="nav-number">4.8.</span> <span class="nav-text">存储/恢复状态机实例</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">william</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("LqPMJve9iAUo8OUAJN0PL99B-gzGzoHsz", "NszposYPlqe9MV8XgiUmnGpt");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

</body>
</html>
